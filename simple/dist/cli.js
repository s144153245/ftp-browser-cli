#!/usr/bin/env node
import Io from"react";import{render as vo}from"ink";import{access as et}from"fs/promises";import{constants as tt}from"fs";import{resolve as ot}from"path";import C from"chalk";var l={directory:C.green,file:C.white,symlink:C.magenta,executable:C.red,border:C.blue,selected:C.cyan,highlight:C.yellow,error:C.red,success:C.green,warning:C.yellow,muted:C.gray,info:C.blue,sizeSmall:C.gray,sizeMedium:C.yellow,sizeLarge:C.red},R={directory:"\u{1F4C1}",file:"\u{1F4C4}",symlink:"\u{1F517}",image:"\u{1F5BC}\uFE0F",video:"\u{1F3AC}",audio:"\u{1F3B5}",archive:"\u{1F4E6}",code:"\u{1F4BB}",text:"\u{1F4DD}",pdf:"\u{1F4D5}",loading:"\u23F3",success:"\u2705",error:"\u274C",warning:"\u26A0\uFE0F",download:"\u2B07\uFE0F",search:"\u{1F50D}",folder:"\u{1F4C2}"},f={topLeft:"\u2554",topRight:"\u2557",bottomLeft:"\u255A",bottomRight:"\u255D",horizontal:"\u2550",vertical:"\u2551",topT:"\u2566",bottomT:"\u2569",leftT:"\u2560",rightT:"\u2563",cross:"\u256C"},x={ftpPort:21,ftpUser:"anonymous",ftpPassword:"",ftpTimeout:1e4,ftpSecure:!1,ftpPassive:!0,itemsPerPage:20,maxPreviewLines:50,maxPreviewBytes:10240,maxSearchDepth:5,searchDebounceMs:300,downloadDir:"./downloads",downloadTimeout:36e5,resumeThreshold:1024,minTerminalWidth:60,maxTerminalWidth:100};var So={small:1024*1024,medium:100*1024*1024},F={dnsResolve:"Cannot resolve hostname",connection:"Cannot connect to FTP server",accessDenied:"Permission denied",timeout:"Connection timeout",login:"Authentication failed",notFound:"File or directory not found",downloadFailed:"Download failed",invalidPath:"Invalid path",noPermission:"No permission to access"},Ze={connecting:"Connecting...",connected:"Connected",disconnecting:"Disconnecting...",disconnected:"Disconnected",loading:"Loading...",searching:"Searching...",downloading:"Downloading...",completed:"Completed",failed:"Failed"};var I={root:"/",parent:"..",current:".",separator:"/"};var V={major:1,minor:0,patch:0,name:"FTP_Browser-CLI",full:"1.0.0"};var kt=`
FTP_Browser-CLI - Interactive FTP browser

Usage:
  ftp-browser [options] <host>
  ftp-browser <host> [options]

Arguments:
  host                    FTP server hostname (required)

Options:
  -u, --user <username>   FTP username (default: anonymous)
  -p, --password <pass>   FTP password (default: '')
  -P, --port <port>       FTP port (default: 21)
  -d, --download-dir <p>  Download directory (default: ./downloads)
  -s, --secure            Use FTPS
  --timeout <ms>          Connection timeout in ms (default: 10000)
  --no-color              Disable colored output
  -v, --version           Show version
  -h, --help              Show this help

Examples:
  ftp-browser 172.17.201.151
  ftp-browser ftp.example.com -u admin -p secret
  ftp-browser ftp.example.com --secure --port 990
`.trim();function Mt(e){let o={},t=[];for(let r=0;r<e.length;r++){let n=e[r];if(n==="--")break;if(n==="-h"||n==="--help"){o.help=!0;continue}if(n==="-v"||n==="--version"){o.version=!0;continue}if(n==="-u"||n==="--user"){o.user=e[++r]??"";continue}if(n==="-p"||n==="--password"){o.password=e[++r]??"";continue}if(n==="-P"||n==="--port"){o.port=e[++r]??String(x.ftpPort);continue}if(n==="-d"||n==="--download-dir"){o["download-dir"]=e[++r]??x.downloadDir;continue}if(n==="-s"||n==="--secure"){o.secure=!0;continue}if(n==="--timeout"){o.timeout=e[++r]??String(x.ftpTimeout);continue}if(n==="--no-color"){o.noColor=!0;continue}n.startsWith("-")||t.push(n)}return o._=t,o}function Bt(){console.log(kt)}function Nt(){console.log(`${V.name} v${V.full}`)}async function Ot(e){let o=ot(process.cwd(),e);try{return await et(o,tt.W_OK),{ok:!0}}catch(t){let r=t;if(r?.code==="ENOENT")try{let{mkdir:n}=await import("fs/promises");return await n(o,{recursive:!0}),await et(o,tt.W_OK),{ok:!0}}catch(n){return{ok:!1,error:`Download dir not writable: ${n?.message??"Unknown error"}`}}return{ok:!1,error:`Download dir not writable: ${r?.message??"Unknown error"}`}}}async function rt(e=process.argv.slice(2)){let o=Mt(e);if(o.help===!0)return Bt(),process.exitCode=0,null;if(o.version===!0)return Nt(),process.exitCode=0,null;let t=o._,r=typeof t?.[0]=="string"?t[0].trim():"";if(!r)return console.error("Error: Host is required. Use -h for help."),process.exitCode=1,null;let n=String(o.port??x.ftpPort),s=parseInt(n,10);if(Number.isNaN(s)||s<1||s>65535)return console.error("Error: Port must be a number between 1 and 65535."),process.exitCode=1,null;let d=String(o.timeout??x.ftpTimeout),u=parseInt(d,10);if(Number.isNaN(u)||u<=0)return console.error("Error: Timeout must be a positive number."),process.exitCode=1,null;let a=String(o["download-dir"]??x.downloadDir),i=await Ot(a);if(!i.ok)return console.error(`Error: ${i.error}`),process.exitCode=1,null;let m=ot(process.cwd(),a);return{config:{host:r,port:s,user:String(o.user??x.ftpUser),password:String(o.password??x.ftpPassword),secure:!!o.secure,timeout:u,passive:x.ftpPassive},downloadDir:m,noColor:!!o.noColor}}import{useEffect as Yt}from"react";import{create as _t}from"zustand";import{Client as At}from"basic-ftp";import{EventEmitter as jt}from"events";import{Writable as Ut}from"stream";import{dirname as zt,join as Ht}from"path";import{promises as nt}from"fs";import{dirname as Oo}from"path";var j=class e extends Error{code;constructor(o,t){super(o),this.name="FTPError",this.code=t,Object.setPrototypeOf(this,e.prototype)}},L=class e extends j{constructor(o=F.connection){super(o,"CONNECTION_ERROR"),this.name="ConnectionError",Object.setPrototypeOf(this,e.prototype)}},he=class e extends j{constructor(o=F.login){super(o,"AUTHENTICATION_ERROR"),this.name="AuthenticationError",Object.setPrototypeOf(this,e.prototype)}},U=class e extends j{constructor(o=F.notFound){super(o,"FILE_NOT_FOUND"),this.name="FileNotFoundError",Object.setPrototypeOf(this,e.prototype)}},we=class e extends j{constructor(o=F.accessDenied){super(o,"PERMISSION_ERROR"),this.name="PermissionError",Object.setPrototypeOf(this,e.prototype)}},xe=class e extends j{constructor(o=F.timeout){super(o,"TIMEOUT_ERROR"),this.name="TimeoutError",Object.setPrototypeOf(this,e.prototype)}},Pe=class e extends j{constructor(o=F.downloadFailed){super(o,"DOWNLOAD_ERROR"),this.name="DownloadError",Object.setPrototypeOf(this,e.prototype)}},ye=class e extends j{constructor(o=F.invalidPath){super(o,"INVALID_PATH_ERROR"),this.name="InvalidPathError",Object.setPrototypeOf(this,e.prototype)}};async function Le(e){try{await nt.mkdir(e,{recursive:!0})}catch(o){if(o instanceof Error){if(o.message.includes("permission")||o.message.includes("EACCES"))throw new we(`Cannot create directory: ${o.message}`);if(o.message.includes("ENOENT")||o.message.includes("invalid"))throw new ye(`Invalid path: ${e}`)}throw o}}async function st(e){try{return(await nt.stat(e)).size}catch{return 0}}function it(e,o,t){let r=t?"l":o?"d":"-",n=s=>(s&4?"r":"-")+(s&2?"w":"-")+(s&1?"x":"-");return r+n(e.user)+n(e.group)+n(e.world)}function Wt(e){return{type:e.isSymbolicLink?"LINK":e.isDirectory?"DIR":"FILE",name:e.name,size:e.size??null,date:e.modifiedAt?e.modifiedAt.toISOString():null,target:e.isSymbolicLink?e.link:void 0,permissions:e.permissions?it(e.permissions,e.isDirectory,e.isSymbolicLink):void 0}}var be=class extends jt{client;config;isConnected=!1;constructor(o){super(),this.client=new At(o.timeout??x.ftpTimeout),this.config=o,this.client.ftp.verbose=!1}async connect(){try{return await this.client.access({host:this.config.host,port:this.config.port??x.ftpPort,user:this.config.user??x.ftpUser,password:this.config.password??x.ftpPassword,secure:this.config.secure??x.ftpSecure}),this.isConnected=!0,this.emit("connected",{host:this.config.host,user:this.config.user}),!0}catch(o){if(this.isConnected=!1,o instanceof Error){let t=o.message.toLowerCase();if(t.includes("timeout")||t.includes("timed out"))throw new xe(F.timeout);if(t.includes("login")||t.includes("auth")||t.includes("530"))throw new he(F.login);if(t.includes("resolve")||t.includes("dns"))throw new L(F.dnsResolve);if(t.includes("connect")||t.includes("refused"))throw new L(F.connection)}throw new L(F.connection)}}async disconnect(){try{this.client.close(),this.isConnected=!1,this.emit("disconnected")}catch{}}async list(o){if(!this.isConnected)throw new L("Not connected to FTP server");try{return(await this.client.list(o)).filter(r=>r.name!=="."&&r.name!=="..").map(Wt).sort((r,n)=>r.type==="DIR"&&n.type!=="DIR"?-1:r.type!=="DIR"&&n.type==="DIR"?1:r.name.localeCompare(n.name))}catch(t){throw t instanceof Error&&(t.message.includes("not found")||t.message.includes("550"))?new U(`${F.notFound}: ${o}`):t}}async download(o,t,r){if(!this.isConnected)throw new L("Not connected to FTP server");await Le(zt(t));let n=0;try{n=await this.client.size(o)}catch{}let s=await st(t),d=s>0&&n>0&&n>s?s:0,u=o.split("/").filter(Boolean).pop()??o,a=d,i=Date.now(),m=i;this.client.trackProgress(p=>{a=d+p.bytesOverall;let h=Date.now(),T=(h-i)/1e3;if(h-m<200)return;m=h;let b=T>0?a/T:0,S=n>0?n-a:0,P=b>0&&S>0?S/b:0,O={id:u,filename:u,remotePath:o,localPath:t,totalSize:n,downloaded:a,speed:b,eta:P,status:"downloading"};r?.(O),this.emit("progress",O)});try{d>0?await this.client.downloadTo(t,o,d):await this.client.downloadTo(t,o);let p={id:u,filename:u,remotePath:o,localPath:t,totalSize:a,downloaded:a,speed:0,eta:0,status:"completed"};r?.(p),this.emit("progress",p)}catch(p){throw this.client.trackProgress(()=>{}),p instanceof Error&&(p.message.includes("not found")||p.message.includes("550"))?new U(`${F.notFound}: ${o}`):new Pe(`${F.downloadFailed}: ${p instanceof Error?p.message:"Unknown error"}`)}this.client.trackProgress(()=>{})}async downloadDirectory(o,t,r){if(!this.isConnected)throw new L("Not connected to FTP server");await Le(t);let n=await this.list(o);for(let s of n){let d=o==="/"?`/${s.name}`:`${o}/${s.name}`,u=Ht(t,s.name);s.type==="DIR"?await this.downloadDirectory(d,u,r):s.type==="FILE"&&await this.download(d,u,r)}}async getFileInfo(o){if(!this.isConnected)throw new L("Not connected to FTP server");try{let t=await this.client.list(o);if(t.length===0)throw new U(`${F.notFound}: ${o}`);let r=t[0];return{path:o,type:r.isSymbolicLink?"LINK":r.isDirectory?"DIR":"FILE",size:r.size??null,date:r.modifiedAt?r.modifiedAt.toISOString():null,permissions:r.permissions?it(r.permissions,r.isDirectory,r.isSymbolicLink):void 0,target:r.isSymbolicLink?r.link:void 0}}catch(t){throw t instanceof U?t:t instanceof Error&&(t.message.includes("not found")||t.message.includes("550"))?new U(`${F.notFound}: ${o}`):t}}async preview(o,t){if(!this.isConnected)throw new L("Not connected to FTP server");let r=t??x.maxPreviewBytes,n=[],s=0,d=new Ut({write(u,a,i){if(s<r){let m=r-s;n.push(u.subarray(0,m)),s+=Math.min(u.length,m)}i()}});try{return await this.client.downloadTo(d,o),Buffer.concat(n).toString("utf-8",0,s)}catch(u){throw u instanceof Error&&(u.message.includes("not found")||u.message.includes("550"))?new U(`${F.notFound}: ${o}`):u}}async search(o,t,r){if(!this.isConnected)throw new L("Not connected to FTP server");let n=r??x.maxSearchDepth,s=[],d=t.toLowerCase(),u=async(a,i)=>{if(!(i>=n))try{let m=await this.list(a);for(let p of m){let h=a==="/"?`/${p.name}`:`${a}/${p.name}`;p.name.toLowerCase().includes(d)&&s.push(p),p.type==="DIR"&&await u(h,i+1)}}catch{}};return await u(o,0),s}on(o,t){return super.on(o,t),this}off(o,t){return super.off(o,t),this}};function ke(e){return new be({host:e.host,port:e.port??x.ftpPort,user:e.user??x.ftpUser,password:e.password??x.ftpPassword,secure:e.secure??x.ftpSecure,timeout:e.timeout??x.ftpTimeout,passive:e.passive??x.ftpPassive})}import{randomUUID as Kt}from"crypto";var at=null;function le(e){at=e}function Qt(){return at}var Ie=new Map,Me=class{downloads=new Map;running=new Set;addDownload(o,t){let r=Kt(),n=o.split("/").filter(Boolean).pop()??o,s={id:r,filename:n,remotePath:o,localPath:t,totalSize:0,downloaded:0,speed:0,eta:0,status:"pending"};return this.downloads.set(r,s),this.run(r),r}async run(o){let t=this.downloads.get(o),r=Qt();if(!t||t.status!=="pending"||!r)return;this.running.add(o),t.status="downloading";let n=Ie.get(o),s=d=>{this.downloads.set(o,{...d,id:o}),n?.(d)};try{await r.download(t.remotePath,t.localPath,s);let d=this.downloads.get(o);d&&(d.status="completed")}catch(d){let u=this.downloads.get(o);u&&(u.status="failed",u.error=d instanceof Error?d.message:"Download failed")}finally{this.running.delete(o),Ie.delete(o)}}cancelDownload(o){let t=this.downloads.get(o);t&&(t.status==="downloading"||t.status==="paused")&&(t.status="cancelled",this.running.delete(o),Ie.delete(o))}pauseDownload(o){}resumeDownload(o){}getDownloads(){return Array.from(this.downloads.values())}onProgress(o,t){Ie.set(o,t)}},oe=new Me;var ve=class{constructor(o){this.ftp=o}cancelled=!1;async search(o,t,r,n){this.cancelled=!1;let s=r??x.maxSearchDepth,d=[],u=t.toLowerCase(),a=async(i,m)=>{if(!(this.cancelled||m>=s)){n?.(i);try{let p=await this.ftp.list(i);for(let h of p){if(this.cancelled)return;let T=i==="/"?`/${h.name}`:`${i}/${h.name}`;h.name.toLowerCase().includes(u)&&d.push(h),h.type==="DIR"&&await a(T,m+1)}}catch{}}};return await a(o,0),d}cancel(){this.cancelled=!0}};function Be(e){return new ve(e)}var H=null,v=_t((e,o)=>({config:null,connected:!1,currentPath:I.root,files:[],loading:!1,error:null,connect:async t=>{e({loading:!0,error:null});try{let r=ke({host:t.host,port:t.port,user:t.user,password:t.password,secure:t.secure,timeout:t.timeout,passive:t.passive});if(H=r,!await r.connect())throw new Error("Connection failed");le(r),e({connected:!0,config:t,loading:!1,error:null,currentPath:I.root});let s=await r.list(I.root);e({files:s,currentPath:I.root})}catch(r){let n=r instanceof Error?r.message:"Connection failed";throw H=null,le(null),e({connected:!1,loading:!1,error:n,config:null}),r}},disconnect:async()=>{e({loading:!0});try{H&&(await H.disconnect(),H=null,le(null)),e({connected:!1,config:null,currentPath:I.root,files:[],loading:!1,error:null})}catch(t){let r=t instanceof Error?t.message:"Disconnect failed";e({loading:!1,error:r})}},listDirectory:async t=>{if(!H||!o().connected)throw new Error("Not connected to FTP server");e({loading:!0,error:null});try{let r=await H.list(t);e({files:r,currentPath:t,loading:!1,error:null})}catch(r){let n=r instanceof Error?r.message:"Failed to list directory";throw e({loading:!1,error:n}),r}},navigate:async t=>{let r=t.startsWith("/")?t:`/${t}`;await o().listDirectory(r)},goBack:async()=>{let t=o().currentPath;if(t===I.root)return;let r=t.split("/").filter(Boolean);r.pop();let n=r.length?`/${r.join("/")}`:I.root;await o().navigate(n)},setError:t=>e({error:t}),clearError:()=>e({error:null})}));function W(){return H}import{create as qt}from"zustand";var w=qt((e,o)=>({mode:"browse",selectedIndex:0,currentPage:0,itemsPerPage:x.itemsPerPage,searchQuery:"",searchResults:[],isSearching:!1,downloads:[],setMode:t=>{e({mode:t}),t!=="browse"&&e({selectedIndex:0,currentPage:0})},setSelectedIndex:t=>e({selectedIndex:Math.max(0,t)}),setCurrentPage:t=>e({currentPage:Math.max(0,t),selectedIndex:0}),setSearchQuery:t=>{e({searchQuery:t}),t===""&&e({searchResults:[],isSearching:!1})},setSearchResults:t=>{e({searchResults:t,selectedIndex:0,currentPage:0})},setIsSearching:t=>e({isSearching:t}),addDownload:t=>{let r=o(),n=r.downloads.findIndex(s=>s.id===t.id);if(n>=0){let s=[...r.downloads];s[n]=t,e({downloads:s})}else e({downloads:[...r.downloads,t]})},updateDownload:(t,r)=>{let n=o(),s=n.downloads.findIndex(u=>u.id===t);if(s<0)return;let d=[...n.downloads];d[s]={...d[s],...r},e({downloads:d})},removeDownload:t=>{e({downloads:o().downloads.filter(r=>r.id!==t)})},resetSelection:()=>e({selectedIndex:0,currentPage:0}),nextPage:t=>{let r=o(),n=Math.ceil(t/r.itemsPerPage),s=Math.min(r.currentPage+1,Math.max(0,n-1));s!==r.currentPage&&e({currentPage:s,selectedIndex:0})},prevPage:()=>{let t=o(),r=Math.max(0,t.currentPage-1);r!==t.currentPage&&e({currentPage:r,selectedIndex:0})},goToFirstPage:()=>e({currentPage:0,selectedIndex:0}),goToLastPage:t=>{let r=o(),n=Math.ceil(t/r.itemsPerPage),s=Math.max(0,n-1);e({currentPage:s,selectedIndex:0})}}));function Ne(e){let o=v(r=>r.connect),t=v(r=>r.disconnect);Yt(()=>{if(e)return o(e).catch(()=>{}),()=>{t().catch(()=>{})}},[e?.host,e?.port,e?.user])}import{useEffect as Ct,useState as Ve,useCallback as fe}from"react";import{Box as q,Text as Et,useApp as Po}from"ink";import yo from"ink-spinner";import{Box as Gt,Text as Oe}from"ink";import{jsx as ct,jsxs as lt}from"react/jsx-runtime";var dt=({host:e,version:o})=>{let t=o||V.full,r=`FTP Browser - ${e}`,n=`v${t}`,s=70,d=f.horizontal.repeat(s-2),u=r.length,a=n.length,i=Math.max(1,s-u-a-4);return lt(Gt,{flexDirection:"column",children:[ct(Oe,{children:l.border(`${f.topLeft}${d}${f.topRight}`)}),lt(Oe,{children:[l.border(f.vertical)," ",r," ".repeat(i),n," ",l.border(f.vertical)]}),ct(Oe,{children:l.border(`${f.leftT}${d}${f.rightT}`)})]})};import{Box as Xt,Text as Jt}from"ink";var Ae=e=>e==null?"N/A":e<1024?`${e}B`:e<1048576?`${(e/1024).toFixed(1)} KB`:e<1073741824?`${(e/1048576).toFixed(1)} MB`:`${(e/1073741824).toFixed(1)} GB`;var pt=(e,o=60)=>e.length<=o?e:`...${e.slice(-(o-3))}`,ut=e=>{if(e<60)return`${e}s`;if(e<3600){let o=Math.floor(e/60),t=e%60;return t>0?`${o}m ${t}s`:`${o}m`}else{let o=Math.floor(e/3600),t=Math.floor(e%3600/60);return t>0?`${o}h ${t}m`:`${o}h`}},mt=e=>`${Ae(e)}/s`;import{jsx as Zt,jsxs as Vt}from"react/jsx-runtime";var ft=({path:e})=>{let t=pt(e||"/",60);return Zt(Xt,{children:Vt(Jt,{children:["\u{1F4CD}"," ",l.info(t)]})})};import{Box as ht,Text as no}from"ink";import{Box as eo,Text as to}from"ink";import{jsx as ro,jsxs as oo}from"react/jsx-runtime";var gt=({item:e,index:o,isSelected:t,onSelect:r,onEnter:n})=>{let s=t?"\u25B8":" ",d=`[${o+1}]`,u=e.type==="DIR"?R.directory:e.type==="LINK"?R.symlink:R.file,a=e.type==="DIR"?"[DIR]":e.type==="LINK"?"[LINK]":"[FILE]",i=e.type==="DIR"?l.directory:e.type==="LINK"?l.symlink:l.file,m=e.size!==null?`(${Ae(e.size)})`:"",p=e.name,h=e.target?` -> ${e.target}`:"",T=t?l.selected:i;return ro(eo,{children:oo(to,{children:[s," ",d,"  ",u," ",a,"  ",T(p),h&&` ${l.muted(h)}`,m&&` ${l.muted(m)}`]})})};import{jsx as Te}from"react/jsx-runtime";var je=({items:e,selectedIndex:o,currentPage:t,itemsPerPage:r,onSelect:n,onEnter:s})=>{let d=Math.ceil(e.length/r),u=t*r,a=Math.min(u+r,e.length),i=e.slice(u,a);return e.length===0?Te(ht,{paddingY:1,children:Te(no,{children:l.muted("Directory is empty")})}):Te(ht,{flexDirection:"column",children:i.map((m,p)=>{let h=u+p;return Te(gt,{item:m,index:h,isSelected:h===o,onSelect:()=>n(h),onEnter:()=>s(m)},`${m.name}-${h}`)})})};import{Box as so,Text as Ue}from"ink";import{jsx as wt,jsxs as xt}from"react/jsx-runtime";var Pt=({currentPage:e,totalPages:o,totalItems:t,mode:r})=>{let s=f.horizontal.repeat(68),d=`Page ${e+1}/${o} (${t} items)`,u=r==="browse"?"[n]Next [p]Prev [/]Search [?]Help":r==="search"?"[Esc]Cancel":r==="preview"||r==="help"?"[Esc]Close":"[Esc]Cancel",a=d.length,i=u.length,m=Math.max(1,70-a-i-4),p=r!=="browse"?`[${r.toUpperCase()}] `:"";return xt(so,{flexDirection:"column",children:[wt(Ue,{children:l.border(`${f.leftT}${s}${f.rightT}`)}),xt(Ue,{children:[l.border(f.vertical)," ",d,p&&l.highlight(p)," ".repeat(m),u," ",l.border(f.vertical)]}),wt(Ue,{children:l.border(`${f.bottomLeft}${s}${f.bottomRight}`)})]})};import{Box as ze,Text as yt,useInput as io}from"ink";import ao from"ink-text-input";import{jsx as We,jsxs as He}from"react/jsx-runtime";var bt=({isActive:e,query:o,onSearch:t,onCancel:r,isSearching:n=!1})=>(io((s,d)=>{e&&d.escape&&r()}),e?He(ze,{flexDirection:"column",children:[He(ze,{children:[He(yt,{children:[R.search," ",l.info("Search:")," "," "]}),We(ao,{value:o,onChange:t,onSubmit:()=>t(o)})]}),n&&We(ze,{children:We(yt,{children:l.muted(Ze.searching)})})]}):null);import{Box as It,Text as K,useInput as co}from"ink";import{jsx as re,jsxs as Fe}from"react/jsx-runtime";var vt=({filePath:e,content:o,onClose:t})=>{co((a,i)=>{(i.escape||i.return)&&t()});let r=70,n=f.horizontal.repeat(r-2),d=o.split(`
`).slice(0,x.maxPreviewLines).join(`
`),u=o.split(`
`).length>x.maxPreviewLines;return Fe(It,{flexDirection:"column",children:[re(K,{children:l.border(`${f.topLeft}${n}${f.topRight}`)}),Fe(K,{children:[l.border(f.vertical)," ",l.highlight(`Preview: ${e}`)," ".repeat(Math.max(1,r-e.length-11)),l.border(f.vertical)]}),re(K,{children:l.border(`${f.leftT}${n}${f.rightT}`)}),Fe(It,{flexDirection:"column",paddingX:1,children:[d.split(`
`).map((a,i)=>re(K,{children:a},i)),u&&re(K,{children:l.muted(`... (truncated, showing first ${x.maxPreviewLines} lines)`)})]}),re(K,{children:l.border(`${f.leftT}${n}${f.rightT}`)}),Fe(K,{children:[l.border(f.vertical)," ",l.muted("Press any key to close")," ".repeat(Math.max(1,r-25)),l.border(f.vertical)]}),re(K,{children:l.border(`${f.bottomLeft}${n}${f.bottomRight}`)})]})};import{Box as Ke,Text as Q,useInput as lo}from"ink";import{jsx as Z,jsxs as Se}from"react/jsx-runtime";var Tt=({onClose:e})=>{lo((n,s)=>{(s.escape||n==="q")&&e()});let o=70,t=f.horizontal.repeat(o-2),r=[{key:"\u2191/k",description:"Move up"},{key:"\u2193/j",description:"Move down"},{key:"Enter",description:"Select item / Enter directory"},{key:"/",description:"Search files"},{key:"d",description:"Download file"},{key:"p",description:"Preview file"},{key:"i",description:"Show file info"},{key:"r",description:"Refresh directory"},{key:"?/h",description:"Show help"},{key:"n",description:"Next page"},{key:"p",description:"Previous page"},{key:"b",description:"Go back"},{key:"q/Esc",description:"Quit / Cancel"},{key:"1-9",description:"Quick select item by number"}];return Se(Ke,{flexDirection:"column",children:[Z(Q,{children:l.border(`${f.topLeft}${t}${f.topRight}`)}),Se(Q,{children:[l.border(f.vertical)," ",l.highlight("Keyboard Shortcuts")," ".repeat(Math.max(1,o-19)),l.border(f.vertical)]}),Z(Q,{children:l.border(`${f.leftT}${t}${f.rightT}`)}),Z(Ke,{flexDirection:"column",paddingX:1,paddingY:1,children:r.map((n,s)=>Se(Ke,{justifyContent:"space-between",children:[Z(Q,{children:l.selected(n.key.padEnd(12))}),Z(Q,{children:n.description})]},s))}),Z(Q,{children:l.border(`${f.leftT}${t}${f.rightT}`)}),Se(Q,{children:[l.border(f.vertical)," ",l.muted("Press Esc or q to close")," ".repeat(Math.max(1,o-24)),l.border(f.vertical)]}),Z(Q,{children:l.border(`${f.bottomLeft}${t}${f.bottomRight}`)})]})};import{Box as De,Text as de}from"ink";import{jsx as Qe,jsxs as ne}from"react/jsx-runtime";var Ft=({progress:e,onCancel:o,onPause:t,onResume:r})=>{let n=e.totalSize>0?Math.round(e.downloaded/e.totalSize*100):0,s=20,d=Math.round(n/100*s),u=s-d,a=`[${"\u2588".repeat(d)}${"\u2591".repeat(u)}]`,i=e.status==="completed"?R.success:e.status==="failed"||e.status==="cancelled"?R.error:e.status==="paused"?R.warning:R.download,m=`${n}%`,p=e.speed>0?mt(e.speed):"0 B/s",h=e.eta>0?`ETA: ${ut(e.eta)}`:"ETA: --",T=e.status==="completed"?l.success:e.status==="failed"||e.status==="cancelled"?l.error:l.info;return ne(De,{flexDirection:"column",children:[Qe(De,{children:ne(de,{children:[i,"  ",e.filename,"  ",a,"  ",m,"  ",p,"  ",h]})}),e.error&&Qe(De,{children:Qe(de,{children:l.error(`Error: ${e.error}`)})}),(o||t||r)&&ne(De,{children:[o&&ne(de,{children:[" ",l.error("[c]Cancel")]}),e.status==="downloading"&&t&&ne(de,{children:[" ",l.warning("[p]Pause")]}),e.status==="paused"&&r&&ne(de,{children:[" ",l.success("[r]Resume")]})]})]})};import{useState as po}from"react";import{Box as $e,Text as _,useInput as uo}from"ink";import{jsx as z,jsxs as _e}from"react/jsx-runtime";var St=({title:e,message:o,options:t=[],onSelect:r,onCancel:n})=>{let[s,d]=po(0);uo((i,m)=>{if(m.escape)n();else if(m.return)t.length>0?r(t[s]):n();else if(m.upArrow||i==="k")t.length>0&&d(p=>p>0?p-1:t.length-1);else if(m.downArrow||i==="j")t.length>0&&d(p=>p<t.length-1?p+1:0);else if(i>="1"&&i<="9"){let p=parseInt(i,10)-1;p>=0&&p<t.length&&r(t[p])}});let u=60,a=f.horizontal.repeat(u-2);return z($e,{flexDirection:"column",alignItems:"center",justifyContent:"center",children:_e($e,{flexDirection:"column",borderStyle:"single",width:u,children:[z(_,{children:l.border(`${f.topLeft}${a}${f.topRight}`)}),_e(_,{children:[l.border(f.vertical)," ",l.highlight(e)," ".repeat(Math.max(1,u-e.length-3)),l.border(f.vertical)]}),z(_,{children:l.border(`${f.leftT}${a}${f.rightT}`)}),z($e,{paddingX:1,paddingY:1,children:z(_,{children:o})}),t.length>0&&z($e,{flexDirection:"column",paddingX:1,paddingY:1,children:t.map((i,m)=>{let p=m===s,h=`[${m+1}] ${i}`;return z(_,{children:p?l.selected(`\u25B8 ${h}`):`  ${h}`},i)})}),z(_,{children:l.border(`${f.leftT}${a}${f.rightT}`)}),_e(_,{children:[l.border(f.vertical)," ",l.muted("Press Enter to select, Esc to cancel")," ".repeat(Math.max(1,u-37)),l.border(f.vertical)]}),z(_,{children:l.border(`${f.bottomLeft}${a}${f.bottomRight}`)})]})})};import{useInput as wo}from"ink";import{useCallback as xo}from"react";import{useCallback as Ye}from"react";function mo(e){if(!e||e==="")return I.root;let o=e.replace(/\/+$/,"");o.startsWith(I.separator)||(o=I.separator+o);let t=o.split(I.separator).filter(n=>n!==""),r=[];for(let n of t)n!==I.current&&(n===I.parent?r.length>0&&r.pop():r.push(n));return I.separator+r.join(I.separator)}function qe(...e){if(e.length===0)return I.root;let o=e.filter(r=>r&&r!=="");if(o.length===0)return I.root;let t=o.join(I.separator);return t.startsWith(I.separator)||(t=I.separator+t),mo(t)}function pe(){let e=v(i=>i.currentPath),o=v(i=>i.navigate),t=v(i=>i.goBack),r=v(i=>i.setError),n=w(i=>i.resetSelection),s=w(i=>i.setMode),d=Ye(async i=>{try{n(),await o(i)}catch(m){r?.(m instanceof Error?m.message:"Navigation failed")}},[o,n,r]),u=Ye(async i=>{if(i.type==="DIR"){let m=e==="/"?`/${i.name}`:qe(e,i.name);await d(m);return}if(i.type==="LINK"){let m=i.target??i.name,p=m.startsWith("/")?m:qe(e,m);await d(p);return}i.type==="FILE"&&s("browse")},[e,d,s]),a=Ye(async()=>{try{n(),await t()}catch(i){r?.(i instanceof Error?i.message:"Go back failed")}},[t,n,r]);return{handleEnter:u,handleGoBack:a,navigateTo:d}}import{useCallback as Ge,useRef as fo,useEffect as go}from"react";function Dt(){let e=W();return e?Be(e):null}function ue(){let e=v(a=>a.currentPath),o=w(a=>a.setSearchResults),t=w(a=>a.setIsSearching),r=w(a=>a.searchQuery),n=fo(null),s=Ge(async a=>{let i=a.trim();if(!i){o([]),t(!1);return}let m=Dt();if(!m){o([]),t(!1);return}t(!0);try{let p=await m.search(e,i,x.maxSearchDepth);o(p)}catch{o([])}finally{t(!1)}},[e,o,t]),d=Ge(a=>{if(n.current&&clearTimeout(n.current),!a.trim()){o([]),t(!1);return}t(!0),n.current=setTimeout(()=>{n.current=null,s(a)},x.searchDebounceMs)},[s,o,t]),u=Ge(()=>{n.current&&(clearTimeout(n.current),n.current=null);let a=Dt();a&&a.cancel(),t(!1)},[t]);return go(()=>()=>{n.current&&clearTimeout(n.current)},[]),{runSearchDebounced:d,cancelSearch:u,runSearch:s}}import{useCallback as Xe}from"react";import{randomUUID as ho}from"crypto";import{join as $t}from"path";function me(e){let o=w(a=>a.addDownload),t=w(a=>a.updateDownload),r=w(a=>a.removeDownload),n=w(a=>a.downloads),s=Xe((a,i)=>{if(a.type!=="FILE")return;let m=i==="/"?`/${a.name}`:`${i}/${a.name}`,p=$t(e,a.name),h=oe.addDownload(m,p),T=oe.getDownloads().find(b=>b.id===h);T&&o(T),oe.onProgress(h,b=>t(h,b))},[o,t,e]),d=Xe((a,i,m)=>{if(a.type!=="DIR")return;let p=i==="/"?`/${a.name}`:`${i}/${a.name}`,h=$t(e,a.name),T=W();if(!T)return;let b=ho(),S={id:b,filename:a.name,remotePath:p,localPath:h,totalSize:0,downloaded:0,speed:0,eta:0,status:"downloading"};o(S),m?T.downloadDirectory(p,h,P=>t(b,{...P,id:b})).catch(P=>{t(b,{status:"failed",error:P instanceof Error?P.message:"Directory download failed"})}):T.download(p,h,P=>t(b,{...P,id:b})).catch(P=>{t(b,{status:"failed",error:P instanceof Error?P.message:"Download failed"})})},[o,t,e]),u=Xe(a=>{oe.cancelDownload(a),r(a)},[r]);return{downloads:n,addFileDownload:s,addDirectoryDownload:d,cancelDownload:u}}function Je(e){let{downloadDir:o,onPreview:t,onInfo:r,onShowModal:n,exit:s}=e,d=pe(),u=ue(),a=me(o),i=w(g=>g.mode),m=w(g=>g.setMode),p=w(g=>g.setSelectedIndex),h=w(g=>g.setCurrentPage),T=w(g=>g.selectedIndex),b=w(g=>g.currentPage),S=w(g=>g.itemsPerPage),P=w(g=>g.setSearchQuery),O=v(g=>g.files),Y=v(g=>g.loading),se=v(g=>g.listDirectory),G=v(g=>g.currentPath),ie=w(g=>g.searchResults),N=i==="search"?ie:O,ge=Math.ceil(N.length/S),E=b*S+T,y=N[E]??null,ae=w(g=>g.prevPage),X=w(g=>g.nextPage),ee=w(g=>g.goToFirstPage),te=w(g=>g.goToLastPage),Ee=xo((g,$)=>{if(!Y){if(g==="q"||$.escape){s();return}if(g==="?"||g==="h"){m("help");return}if($.upArrow||g==="k"){if(E>0){let k=E-1,M=Math.floor(k/S),J=k%S;h(M),p(J)}return}if($.downArrow||g==="j"){if(E<N.length-1){let k=E+1,M=Math.floor(k/S),J=k%S;h(M),p(J)}return}if($.pageUp){ae();return}if(g==="n"||$.pageDown){X(N.length);return}if(g==="g"){ee();return}if(g==="G"){te(N.length);return}if($.backspace||g==="b"){d.handleGoBack();return}if($.return){y&&(y.type==="FILE"?n(y):d.handleEnter(y));return}if(g==="/"){m("search"),P("");return}if(g==="r"){se(G).catch(()=>{});return}if(g==="d"&&y){y.type==="FILE"?a.addFileDownload(y,G):y.type==="DIR"&&a.addDirectoryDownload(y,G,!0);return}if(g==="p"&&y?.type==="FILE"){t(y);return}if(g==="i"&&y){r(y);return}if(g>="1"&&g<="9"){let k=parseInt(g,10)-1,M=b*S+k;if(M<N.length){let J=Math.floor(M/S),Re=M%S;h(J),p(Re);let c=N[M];c&&(c.type==="DIR"||c.type==="LINK")?d.handleEnter(c):c?.type==="FILE"&&n(c)}}}},[Y,E,N,S,b,y,G,m,h,p,P,ae,X,ee,te,se,d,a,t,r,n,s]);wo((g,$)=>{if(i==="help"||i==="preview"){(g==="q"||$.escape)&&m("browse");return}if(i==="search"){$.escape&&(u.cancelSearch(),m("browse"),P(""));return}i!=="connecting"&&i==="browse"&&Ee(g,$)})}import{jsx as D,jsxs as Ce}from"react/jsx-runtime";var Rt=({config:e,downloadDir:o})=>{let{exit:t}=Po(),r=w(c=>c.mode),n=w(c=>c.setMode),s=w(c=>c.setSearchQuery),d=w(c=>c.searchQuery),u=w(c=>c.searchResults),a=w(c=>c.isSearching),i=w(c=>c.selectedIndex),m=w(c=>c.currentPage),p=w(c=>c.itemsPerPage),h=w(c=>c.downloads),T=w(c=>c.setCurrentPage),b=w(c=>c.setSelectedIndex),S=v(c=>c.files),P=v(c=>c.currentPath),O=v(c=>c.loading),Y=v(c=>c.error),se=v(c=>c.connected),[G,ie]=Ve(null),[N,ge]=Ve(""),[E,y]=Ve(null),ae=pe(),X=ue(),ee=me(o);Ct(()=>{n("connecting")},[]),Ct(()=>{r==="connecting"&&!O&&(se||Y)&&n("browse")},[r,O,se,Y,n]);let te=r==="search"?u:S,Ee=Math.max(1,Math.ceil(te.length/p)),g=m*p+i,$=fe(async c=>{if(c.type!=="FILE")return;let B=P==="/"?`/${c.name}`:`${P}/${c.name}`,A=W();if(A)try{let ce=await A.preview(B,x.maxPreviewBytes);ie(c.name),ge(ce),n("preview")}catch{ge(`Failed to preview ${c.name}`),ie(c.name),n("preview")}},[P,n]),k=fe(async c=>{let B=P==="/"?`/${c.name}`:`${P}/${c.name}`,A=W();if(A)try{let ce=await A.getFileInfo(B);y({title:`Info: ${c.name}`,message:`Type: ${ce.type} | Size: ${ce.size??"N/A"} | Date: ${ce.date??"N/A"}`,options:[],onSelect:()=>y(null),onCancel:()=>y(null)})}catch{y({title:`Info: ${c.name}`,message:"Failed to fetch file info.",options:[],onSelect:()=>y(null),onCancel:()=>y(null)})}},[P]),M=fe(c=>{y({title:`File: ${c.name}`,message:`Select an action for ${c.name}:`,options:["Download","Preview","Info"],onSelect:B=>{y(null),B==="Download"?ee.addFileDownload(c,P):B==="Preview"?$(c):B==="Info"&&k(c)},onCancel:()=>y(null)})},[P,ee,$,k]);Je({downloadDir:o,onPreview:$,onInfo:k,onShowModal:M,exit:t});let J=fe(c=>{s(c),X.runSearchDebounced(c)},[s,X]),Re=fe(()=>{X.cancelSearch(),n("browse"),s("")},[X,n,s]);return Ce(q,{flexDirection:"column",children:[D(dt,{host:e.host}),D(q,{height:1}),D(ft,{path:P}),D(q,{height:1}),O&&r==="connecting"&&D(q,{children:Ce(Et,{children:[D(yo,{type:"dots"})," ",l.info("Connecting...")]})}),Y&&D(q,{children:Ce(Et,{children:[R.error," ",l.error(Y)]})}),r==="browse"&&!O&&D(je,{items:te,selectedIndex:g,currentPage:m,itemsPerPage:p,onSelect:c=>{let B=Math.floor(c/p),A=c%p;T(B),b(A)},onEnter:c=>{c.type==="FILE"?M(c):ae.handleEnter(c)}}),r==="search"&&Ce(q,{flexDirection:"column",children:[D(bt,{isActive:!0,query:d,onSearch:J,onCancel:Re,isSearching:a}),u.length>0&&D(je,{items:u,selectedIndex:g,currentPage:m,itemsPerPage:p,onSelect:c=>{let B=Math.floor(c/p),A=c%p;T(B),b(A)},onEnter:c=>{c.type==="FILE"?$(c):ae.handleEnter(c)}})]}),r==="preview"&&G&&D(vt,{filePath:G,content:N,onClose:()=>{n("browse"),ie(null),ge("")}}),r==="help"&&D(Tt,{onClose:()=>n("browse")}),h.length>0&&D(q,{flexDirection:"column",children:h.map(c=>D(Ft,{progress:c,onCancel:()=>ee.cancelDownload(c.id)},c.id))}),D(q,{height:1}),D(Pt,{currentPage:m,totalPages:Ee,totalItems:te.length,mode:r}),E&&D(St,{title:E.title,message:E.message,options:E.options,onSelect:E.onSelect,onCancel:E.onCancel})]})};import{jsx as bo}from"react/jsx-runtime";function Lt({config:e,downloadDir:o}){return Ne(e),bo(Rt,{config:e,downloadDir:o})}async function To(){let e=await rt();if(!e){process.exit(process.exitCode??0);return}process.stdout.isTTY||(console.error("Error: This application requires an interactive terminal (TTY)."),process.exit(1)),console.clear(),console.log("\x1B[36m\u250C\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\x1B[0m"),console.log("\x1B[36m\u2502\x1B[0m  \x1B[1m\x1B[32m%s\x1B[0m  \x1B[36m\u2502\x1B[0m",V.name.padEnd(43)),console.log("\x1B[36m\u2502\x1B[0m  Host: %s  \x1B[36m\u2502\x1B[0m",e.config.host.padEnd(42)),console.log("\x1B[36m\u2502\x1B[0m  Download dir: %s  \x1B[36m\u2502\x1B[0m",e.downloadDir.padEnd(36)),console.log("\x1B[36m\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\x1B[0m"),console.log();let{waitUntilExit:o}=vo(Io.createElement(Lt,{config:e.config,downloadDir:e.downloadDir}));await o(),console.log(`
\x1B[32mGoodbye.\x1B[0m
`),process.exit(0)}To().catch(e=>{console.error("Fatal error:",e instanceof Error?e.message:e),process.exit(1)});
